# Архиватор файлов

## Предисловие
Я реализовал систему на Go 1.24, которая позволяет пользователям создавать задачи для скачивания и архивирования файлов по URL.
Функционал:
- Создание задачи на упаковку файлов.
- Добавление ссылок на файлы в задачу и их Lazy-downloading.
- Получение статуса задачи, включая ссылку на готовый архив.
- Ограничение на максимальное количество файлов в задаче (3).
- Ограничение на максимальное количество одновременно обрабатываемых задач (3).
- Получение подробной информации об ошибках помимо статуса, при этом архив будет создан из доступных файлов.


## Паттерны и практики
При выполнении использовал классическую 3-Layer Architecture (Routes, Services, Repositories), что сделало код более читаемым и понятным. Роутер взял из внешнего пакета go-chi, что позволило ускорить процесс разработки.

Не использовал внешнюю инфраструктуру, за исключением сваггера. Его я использовал для удобства ручного тестирования и документации эндпоинтов. Поскольку он работает внутри моего кода, не требует внешних сервисов и не создаёт runtime зависимостей - его можно не считать внешней инфраструктурой.

Также для удобства отладки я подключил логгер из пакета log/slog. При необходимости масштабировать проект это позволит вынести логи в Sentry, GlitchTip и.т.п..

Чтобы реализовать функциональные требования использовал семафор для загрузки и мьютекс для работы с мапой. Отдельно написал функцию проверки на 3 активные задачи.

Мной была написана конфигурация http сервера и допустимых расширений файлов в файле .env.public (Расширение я валидирую простым сравнением суффикса урла):
```.env.public
ENVIRONMENT=development
HTTP_PORT=:8080
HTTP_TIMEOUT=60s
HTTP_IDLE_TIMEOUT=180s
ALLOWED_EXTENSIONS=.pdf,.jpeg,.jpg
``` 
Конечно, .env файлы продакшн кода коммитить нельзя, но так как это тестовое задание, то можно. С .env файлом работал через пакет github.com/ilyakaznacheev/cleanenv 

## Запуск
Для удобного запуска написал Makefile. Для установки сборки и запуска потребуется лишь скопировать и ввести в терминал следующий код:
```bash
git clone https://github.com/SanKdrv/2025-07-30
cd 2025-07-30
make start
```
## Выключение
При посылании SIGINT|SIGTERM в программу происходит gracefully shutdown, после которого удаляются папки, используемые для хранения статики.


## API
Вся документация лежит по url: 
http://localhost:8080/swagger/index.html

## Вызов эндпоинтов через curl
* /api/tasks/create
```/api/tasks/create
curl -X 'POST' \
  'http://localhost:8080/api/tasks/create' \
  -H 'accept: application/json' \
  -d ''
```

* /api/tasks/{id}/add-link
```/api/tasks/{id}/add-link
curl -X 'POST' \
  'http://localhost:8080/api/tasks/0/add-link' \ //{id} = 0
  -H 'accept: application/json' \
  -H 'Content-Type: application/x-www-form-urlencoded' \
  -d 'link=https%3A%2F%2Fjojo.fandom.com%2Fru%2Fwiki%2F%25D0%2594%25D0%25B8%25D0%25B5%25D0%25B3%25D0%25BE_%25D0%2591%25D1%2580%25D0%25B0%25D0%25BD%25D0%25B4%25D0%25BE'
```

* /api/tasks/{id}/status
```/api/tasks/{id}/status
curl -X 'GET' \
  'http://localhost:8080/api/tasks/0/status' \ // {id} = 0
  -H 'accept: application/json'
```

* /api/archives/{id}/download
```/api/archives/{id}/download
curl -X 'GET' \
  'http://localhost:8080/api/archives/0/download' \ // {id} = 0
  -H 'accept: application/zip'
```